<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate WARP Generator v1.4.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        
        .gradient-text { 
            background-image: linear-gradient(to right, #6d28d9, #4f46e5); 
            -webkit-background-clip: text; 
            background-clip: text; 
            color: transparent; 
        }
        body { background-color: #111827; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: bold; margin-bottom: 0.75rem; margin-top: 1.5rem; }
        .markdown-content h1 { font-size: 1.875rem; line-height: 2.25rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem;}
        .markdown-content h2 { font-size: 1.5rem; line-height: 2rem; }
        .markdown-content h3 { font-size: 1.25rem; line-height: 1.75rem; }
        .markdown-content p, .markdown-content ul, .markdown-content ol { margin-bottom: 1rem; line-height: 1.75; }
        .markdown-content ul, .markdown-content ol { list-style-position: inside; }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        
        .markdown-content a { 
            color: #818cf8; /* Indigo-400 */
            text-decoration: underline; 
        }
        .markdown-content code { background-color: #1f2937; color: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.9em; }
        .markdown-content strong { color: #f9fafb; }
        .content-section { border: 2px solid #374151; transition: border-color 0.2s ease-in-out; }
        .content-section.active { border-color: #4f46e5; } /* Changed from orange */
        .endpoint-tab { padding: 0.5rem 1rem; border-radius: 0.375rem 0.375rem 0 0; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; }
        .endpoint-tab.active { background-color: #1f2937; color: #818cf8; border-bottom: 2px solid #818cf8; } /* Changed from orange */
        .endpoint-tab:not(.active) { background-color: #374151; color: #9ca3af; }
        .endpoint-tab:not(.active):hover { background-color: #4b5563; color: #d1d5db; }
        .endpoint-tab-content { padding: 1rem; border-radius: 0 0 0.375rem 0.375rem; background-color: #1f2937; }
        .endpoint-tab-content.hidden { display: none; }
        /* Latency indicator styles */
        .latency-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 0.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .latency-fast { background-color: #10b981; } /* green */
        .latency-medium { background-color: #f59e0b; } /* yellow */
        .latency-slow { background-color: #ef4444; } /* red */
        .latency-unknown { background-color: #6b7280; } /* gray */
        .testing-indicator { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        /* Mirror notice styles */
        .mirror-notice { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        /* NEW: Custom Modal Styles */
        .modal-backdrop { animation: fadeIn 0.2s ease-out; }
        .modal-content { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans flex flex-col items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-7xl">
        <header class="text-center mb-8">
            <img src="logo.png" alt="Logo" class="mx-auto w-24 h-24 rounded-full mb-4 border-2 border-purple-500/50">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight gradient-text">Ultimate WARP Generator</h1>
            <p class="text-gray-400 mt-2 text-lg">Generate & manage shareable configs for any client.</p>
            
            </header>
        <div id="initial-section" class="text-center">
            <div id="first-time-generator">
                <button id="generateBtn" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out inline-flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Generate First Config
                </button>
            </div>
            <div id="config-manager" class="hidden bg-gray-800/50 border border-gray-700/50 rounded-2xl p-6">
                <h2 class="text-xl font-bold text-white mb-4">Your Saved Configurations</h2>
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <select id="savedConfigsDropdown" class="block w-full sm:w-auto flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    <button id="updateEndpointsBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Refresh Endpoints</button>
                </div>
                <div class="mt-4 flex flex-wrap justify-center gap-3">
                    <button id="generateNewBtn" class="bg-purple-700 hover:bg-purple-800 text-white font-semibold py-2 px-4 rounded-lg">Generate New</button>
                    <button id="renameConfigBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Rename</button>
                    <button id="deleteConfigBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Delete</button>
                </div>
            </div>
            <p id="statusText" class="text-gray-400 text-sm mt-4 h-5"></p>
        </div>

        <div id="results" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8 mt-6">
            <div id="results-output" class="lg:col-span-2"></div>
            <div id="results-sidebar" class="space-y-6"></div>
        </div>
    </div>

    <div id="customModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-2xl shadow-xl max-w-md w-full p-6">
            <h2 id="modalTitle" class="text-xl font-bold text-white mb-4">Modal Title</h2>
            <p id="modalDescription" class="text-gray-300 mb-4">Description goes here.</p>
            <input id="modalInput" type="text" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
            <div class="flex justify-end gap-4 mt-6">
                <button id="modalCancel" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition-colors">Cancel</button>
                <button id="modalConfirm" class="bg-purple-700 hover:bg-purple-800 text-white font-semibold py-2 px-5 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-8 mt-12 w-full">
        <p class="text-sm text-gray-400">
            Created with ü§ç by <span class="font-semibold text-gray-300">F0rc3Run</span>
        </p>
        
        <p class="text-sm text-gray-400 mt-2">
            <a href="https://github.com/F0rc3Run/F0rc3Run" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors">
                Support us with a üåü on GitHub
            </a>
        </p>
        
        <div class="mt-4 flex justify-center space-x-6">
            <a href="https://t.me/ForceRunVPN" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" aria-label="Telegram">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.33 1.43.18 1.15 1.3l-2.72 12.81c-.19.91-.74 1.13-1.51.71l-4.88-3.58-2.32 2.23c-.25.28-.46.48-.93.48z"/></svg>
            </a>
            <a href="https://github.com/F0rc3Run" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" aria-label="GitHub">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
            </a>
        </div>
</footer>
    
<script>
// App version
const APP_VERSION = '1.4.2';

document.addEventListener('DOMContentLoaded', () => {
    // Multi-language support
    const translations = {
        en: {
            // English translations (default)
            title: "Ultimate WARP Generator",
            subtitle: "Generate & manage shareable configs for any client.",
            generateFirstConfig: "Generate First Config",
            yourSavedConfigurations: "Your Saved Configurations",
            generateNew: "Generate New",
            rename: "Rename",
            delete: "Delete",
            updateEndpoints: "Refresh Endpoints",
            configurationsReady: "Your Configurations are Ready!",
            configurationPreview: "Configuration Preview & Sharing",
            standardWG: "Standard WG",
            amneziaWG: "AmneziaWG",
            singBox: "Sing-Box",
            appUrls: "App URLs",
            standardWireGuardFormat: "Standard WireGuard Format",
            amneziaWGFormat: "AmneziaWG Format (Jitter)",
            singBoxFormat: "sing-box Format (URL-Test)",
            clientSpecificUrls: "Client-Specific URLs",
            selectEndpoint: "Select an Endpoint",
            ipv4: "IPv4",
            ipv6: "IPv6",
            recommended: "Recommended",
            recommendedText: "Endpoints starting with 8.x.x.x may offer better performance on some ISPs.",
            ipv6Text: "IPv6 endpoints for networks that support IPv6 connectivity.",
            selectDns: "Select DNS Server",
            cloudflare: "Cloudflare (1.1.1.1)",
            google: "Google (8.8.8.8)",
            quad9: "Quad9 (9.9.9.9)",
            opendns: "OpenDNS (208.67.222.220)",
            custom: "Custom...",
            downloadClient: "Download a Compatible Client:",
            windows: "Windows",
            android: "Android",
            ios: "iOS",
            linux: "Linux",
            copy: "Copy",
            downloadConf: "Download .conf",
            shareLink: "Share Link",
            copied: "Copied!",
            linkCopied: "Link Copied!",
            sharing: "Sharing...",
            enterName: "Enter a name for this new configuration:",
            configNamePlaceholder: "My Home Config",
            enterNewName: "Enter a new name for this configuration:",
            deleteConfirm: "Are you sure you want to delete \"{name}\"? This cannot be undone.",
            configurationDeleted: "Configuration deleted.",
            configurationRenamed: "Configuration renamed.",
            newConfigSaved: "New config saved! Loading...",
            registeringAccount: "Registering new WARP account...",
            fetchingEndpoints: "Fetching latest endpoint list...",
            endpointFetchFailed: "Endpoint fetch failed. Using random fallback.",
            loadingConfig: "Loading selected config with latest endpoints...",
            errorOccurred: "An error occurred. Please try again.",
            enterCustomDns: "Please enter a custom DNS address.",
            enterDnsName: "Enter a name for this DNS entry:\n{value}",
            myCustomDns: "My Custom DNS",
            dnsAlreadySaved: "This DNS address is already saved.",
            deleteDnsConfirm: "Are you sure you want to delete the DNS entry \"{value}\"?",
            noIPv4Endpoints: "No IPv4 endpoints available",
            noIPv6Endpoints: "No IPv6 endpoints available",
            // howToUse: "How to Use", // Removed
            // helpFileError: "Error: Could not load the help file (readme.md).", // Removed
            createdBy: "Created with ‚ù§Ô∏è by",
            qrCodeStandard: "QR Code (Standard WG)",
            qrCodeAmnezia: "QR Code (AmneziaWG)",
            qrCodeNotScannable: "QR Code (Not Scannable)",
            qrCodeSingBox: "sing-box Share Link QR",
            nekoBoxAndroid: "NekoBox (Android)",
            v2RayNGAndroid: "V2RayNG (Android)",
            streisandiOS: "Streisand (iOS)",
            shadowrocketStandard: "Shadowrocket - Standard (iOS)",
            shadowrocketAmnezia: "Shadowrocket - Amnezia (iOS)",
            clickForQrCode: "Click a section below to generate its QR code. Formats update automatically when you change Endpoint or DNS.",
            language: "Language",
            save: "Save",
            shareFailed: "Failed to share config.",
            testLatency: "Test Latency",
            testingLatency: "Testing latency...",
            latencyFast: "Fast",
            latencyMedium: "Medium",
            latencySlow: "Slow",
            latencyUnknown: "Unknown",
            autoSelectFastest: "Auto-select Fastest",
            mirrorNotice: "Alternative Mirror:",
            ifNotAccessible: "(if this site is not accessible)",
            noSavedConfigsError: "You have no saved configurations to create a subscription from.",
            appSubscriptionLinksTitle: "App Subscription Links",
            appSubscriptionLinksDesc: "Add the appropriate link to your client. It will update automatically.",
            nekoBoxV2rayNG: "V2RayNG",
            close: "Close",
            cancel: "Cancel",
        }
    };
    // Language detection and storage
    const LANGUAGE_STORAGE_KEY = 'warpGeneratorLanguage';
    const DEFAULT_LANGUAGE = 'en';
    let currentLanguage = getInitialLanguage();

    class ShzAlClient { constructor(b = 'https://shz.al') { this.b = b.endsWith('/') ? b.slice(0, -1) : b } async _h(r) { if (!r.ok) { const e = await r.text(); throw new Error(`API Error: ${r.status} ${r.statusText} - ${e}`) } return r } async uploadPaste(c, o = {}) { const f = new FormData(); f.append('c', c); if (o.expiration) f.append('e', o.expiration); const r = await fetch(this.b + '/', { method: 'POST', body: f }); await this._h(r); return r.json() } }
    // Get saved language or detect browser language
    function getInitialLanguage() {
        return 'en';
    }
    // Set the current language
    function setLanguage(lang) {
        if (translations[lang]) {
            currentLanguage = lang;
            localStorage.setItem(LANGUAGE_STORAGE_KEY, lang);

            // Update all UI elements
            updateUILanguage();
            initialize();
        }
    }
    // Get translation for a key
    function t(key, replacements = {}) {
        let text = translations[currentLanguage]?.[key] || translations[DEFAULT_LANGUAGE][key] || key;
        Object.entries(replacements).forEach(([placeholder, value]) => {
            text = text.replace(new RegExp(`{${placeholder}}`, 'g'), value);
        });
        return text;
    }

    // Update all UI elements with translations
    function updateUILanguage() {
        // Update static elements
        document.querySelector('h1').textContent = t('title');
        document.querySelector('p.text-gray-400.mt-2.text-lg').textContent = t('subtitle');
        // document.getElementById('howToUseBtn').textContent = t('howToUse'); // Removed
        document.getElementById('generateBtn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>${t('generateFirstConfig')}`;

        // Update config manager
        const configManager = document.getElementById('config-manager');
        if (configManager && !configManager.classList.contains('hidden')) {
            configManager.querySelector('h2').textContent = t('yourSavedConfigurations');
            document.getElementById('generateNewBtn').textContent = t('generateNew');
            document.getElementById('renameConfigBtn').textContent = t('rename');
            document.getElementById('deleteConfigBtn').textContent = t('delete');
            document.getElementById('updateEndpointsBtn').textContent = t('updateEndpoints');
        }

        // Update footer
        // Footer is now static from index(1).html, no update needed here.

        // Check if results section is visible
        const resultsSection = document.getElementById('results');
        if (resultsSection && !resultsSection.classList.contains('hidden')) {
            // Save current state before re-rendering
            const activeTab = document.querySelector('.tab-btn.border-indigo-500'); // Changed from orange
            const activeTabTarget = activeTab ? activeTab.dataset.tabTarget : '#tab-standard';
            const selectedEndpoint = document.querySelector('input[name="endpoint-selector-main"]:checked')?.value || currentEndpoint;
            const selectedDns = document.querySelector('.dns-select')?.value || currentDns;
            const customDnsValue = document.querySelector('.dns-custom-input')?.value || '';

            // Re-render results section with new language
            renderResults();

            // Restore state after re-rendering
            setTimeout(() => {
                // Restore active tab
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('border-indigo-500', 'text-indigo-400'); // Changed from orange
                    btn.classList.add('border-transparent', 'text-gray-400');
                });

                const newActiveTab = document.querySelector(`.tab-btn[data-tab-target="${activeTabTarget}"]`);
                if (newActiveTab) {
                    newActiveTab.classList.add('border-indigo-500', 'text-indigo-400'); // Changed from orange
                    newActiveTab.classList.remove('border-transparent', 'text-gray-400');

                    // Show corresponding tab content
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                    const activePane = document.querySelector(activeTabTarget);
                    if (activePane) activePane.classList.remove('hidden');

                    // Update QR code for active tab
                    updateQrCodeForActiveTab(activeTabTarget.replace('#', ''));

                    // =========================================================
                    // START: ADD THIS FIX
                    // This re-applies the logic to hide/show the settings panel
                    const resultsSidebar = document.getElementById('results-sidebar');
                    const settingsPanel = document.getElementById('settings-panel');

                    if (activeTabTarget === '#tab-singbox' || activeTabTarget === '#tab-app-urls') {
                        resultsSidebar.classList.remove('space-y-6');
                        settingsPanel.classList.add('hidden');
                    } else {
                        resultsSidebar.classList.add('space-y-6');
                        settingsPanel.classList.remove('hidden');
                    }
                    // END: ADD THIS FIX
                    // =========================================================
                }

                // Restore endpoint selection
                if (selectedEndpoint) {
                    document.querySelectorAll('input[name="endpoint-selector-main"]').forEach(radio => {
                        radio.checked = radio.value === selectedEndpoint;
                    });
                }

                // Restore DNS selection
                const dnsSelect = document.querySelector('.dns-select');
                if (dnsSelect) {
                    dnsSelect.value = selectedDns;
                    const isCustom = !Array.from(dnsSelect.options).some(opt => opt.value === selectedDns);
                    if (isCustom) dnsSelect.value = 'custom';

                    const isCustomSelected = dnsSelect.value === 'custom';
                    const container = dnsSelect.closest('.dns-container');
                    container.querySelector('.dns-custom-input').classList.toggle('hidden', !isCustomSelected);
                    if (isCustomSelected && customDnsValue) {
                        container.querySelector('.dns-custom-input').value = customDnsValue;
                    }

                    const selectedOption = Array.from(dnsSelect.options).find(opt => opt.value === dnsSelect.value);
                    const isDataCustom = selectedOption && selectedOption.dataset.customDns === 'true';
                    container.querySelector('.save-custom-dns-btn').classList.toggle('hidden', !isCustomSelected);
                    container.querySelector('.delete-custom-dns-btn').classList.toggle('hidden', !isDataCustom);
                }

                // Update configurations with new language
                updateDisplayedConfigs();
            }, 100);
        }
    }
    updateUILanguage();
    
    // Globals
    const statusText = document.getElementById('statusText');
    const resultsDiv = document.getElementById('results');
    const firstTimeGeneratorDiv = document.getElementById('first-time-generator');
    const configManagerDiv = document.getElementById('config-manager');
    const generateBtn = document.getElementById('generateBtn');
    const generateNewBtn = document.getElementById('generateNewBtn');
    const savedConfigsDropdown = document.getElementById('savedConfigsDropdown');
    const updateEndpointsBtn = document.getElementById('updateEndpointsBtn');
    const renameConfigBtn = document.getElementById('renameConfigBtn');
    const deleteConfigBtn = document.getElementById('deleteConfigBtn');
    // const howToUseBtn = document.getElementById('howToUseBtn'); // Removed
    // const howToUseModal = document.getElementById('howToUseModal'); // Removed
    // const closeModalBtn = document.getElementById('closeModalBtn'); // Removed
    // const howToUseContent = document.getElementById('howToUseContent'); // Removed
    const generateSubLinkBtn = document.getElementById('generateSubLinkBtn');
    const loadingButtonHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${t('sharing')}`;
    let generatedConfigs = null, currentAccount = null, allFetchedEndpoints = [];
    let currentEndpoint = '', currentDns = '1.1.1.1';
    
    // Storage and Constants
    const STORAGE_KEY = 'warpGeneratorAccounts';
    const CUSTOM_DNS_STORAGE_KEY = 'warpGeneratorCustomDns';
    const idToConfigKeyMap = { 'nekobox-section': 'nekoboxJson', 'v2rayng-section': 'v2rayngUrl', 'streisand-section': 'streisandUrl', 'shadowrocket-std-section': 'shadowrocketStandardUrl', 'shadowrocket-amz-section': 'shadowrocketAmneziaUrl' };
    const shzAl = new ShzAlClient();

    // ================================================================
    // MODAL HELPER FUNCTIONS
    // ================================================================
    let modalResolve = null;
    const customModal = document.getElementById('customModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalDescription = document.getElementById('modalDescription');
    const modalInput = document.getElementById('modalInput');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');

    function showModal({ title, description, placeholder, confirmText, initialValue = '' }) {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalDescription.textContent = description;
            modalInput.placeholder = placeholder || '';
            modalInput.value = initialValue;
            modalConfirm.textContent = confirmText || 'Confirm';
            customModal.classList.remove('hidden');
            modalInput.focus();
            modalResolve = resolve;
        });
    }

    modalConfirm.addEventListener('click', () => {
        if (modalResolve) modalResolve(modalInput.value);
        customModal.classList.add('hidden');
        modalResolve = null;
    });
    modalCancel.addEventListener('click', () => {
        if (modalResolve) modalResolve(null); // Resolve with null on cancel
        customModal.classList.add('hidden');
        modalResolve = null;
    });
    document.addEventListener('keydown', (e) => { 
        if (e.key === "Escape" && !customModal.classList.contains('hidden')) modalCancel.click(); 
    });

    // ================================================================
    // CORE FUNCTIONS
    // ================================================================
    const getSavedAccounts = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const saveAccounts = (accounts) => localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
    const getCustomDnsList = () => JSON.parse(localStorage.getItem(CUSTOM_DNS_STORAGE_KEY) || '[]');
    const saveCustomDnsList = (dnsList) => localStorage.setItem(CUSTOM_DNS_STORAGE_KEY, JSON.stringify(dnsList));
    function setStatus(message) { statusText.textContent = message; }
    const generateRandomString = (len) => Array.from({ length: len }, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'.charAt(Math.floor(Math.random() * 62))).join('');

    async function fetchAccountFromWorker() {
        setStatus(t('registeringAccount'));
        const keypair = await generateWireGuardKeypair();
        const privateKey = keypair.privateKey, publicKey = keypair.publicKey;
        const installId = generateRandomString(22);
        const response = await fetch('https://corsproxy.io/?url=https://api.cloudflareclient.com/v0a4005/reg', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: publicKey, install_id: installId, fcm_token: `${installId}:APA91b${generateRandomString(134)}`, tos: new Date().toISOString(), type: 'Android', locale: 'en_US' }), });
        if (!response.ok) throw new Error(`API Account failed: ${response.status}`); const accountData = await response.json();
        return { privateKey, v4: accountData.config.interface.addresses.v4, v6: accountData.config.interface.addresses.v6, peerPublicKey: accountData.config.peers[0].public_key, reserved: Array.from(atob(accountData.config.client_id)).map(c => c.charCodeAt(0)) };
    }
    
    async function fetchAllEndpoints() {
        setStatus(t('fetchingEndpoints'));
        try {
            const response = await fetch('https://raw.githubusercontent.com/ircfspace/endpoint/main/ip.json'); 
            if (!response.ok) throw new Error('Endpoint list fetch failed');
            const text = await response.text(); 
            const data = JSON.parse(text.replace(/[\u200B-\u200D\uFEFF]/g, '')); 
            const ipv4Recommended = data.ipv4.filter(ip => ip.startsWith('8.'));
            const ipv4Others = data.ipv4.filter(ip => !ip.startsWith('8.'));
            ipv4Recommended.sort(() => 0.5 - Math.random());
            ipv4Others.sort(() => 0.5 - Math.random());
            const sortedIPv4 = [...ipv4Recommended, ...ipv4Others];
            const shuffledIPv6 = [...data.ipv6].sort(() => 0.5 - Math.random());
            return { ipv4: sortedIPv4, ipv6: shuffledIPv6 };
        } catch (error) { 
            setStatus(t('endpointFetchFailed')); 
            return { 
                ipv4: Array.from({length: 5}, () => "162.159.192." + Math.floor(Math.random() * 256) + ":2408"),
                ipv6: []
            }; 
        }
    }
    
    function generateAllFormats(account, endpoint, dns) {
        const singboxTemplate = { "dns": { "final": "local-dns", "rules": [ { "action": "route", "clash_mode": "Global", "server": "proxy-dns", "source_ip_cidr": [ "172.19.0.0/30", "fdfe:dcba:9876::1/126" ] }, { "action": "route", "server": "proxy-dns", "source_ip_cidr": [ "172.19.0.0/30", "fdfe:dcba:9876::1/126" ] }, { "action": "route", "clash_mode": "Direct", "server": "direct-dns" }, { "action": "route", "rule_set": [ "geosite-ir" ], "server": "direct-dns" } ], "servers": [ { "address": "tcp://1.1.1.1", "address_resolver": "local-dns", "detour": "proxy", "tag": "proxy-dns" }, { "address": "local", "detour": "direct", "tag": "local-dns" }, { "address": "tcp://8.8.8.8", "detour": "direct", "tag": "direct-dns" } ], "strategy": "prefer_ipv4" }, "inbounds": [ { "address": [ "172.19.0.1/30", "fdfe:dcba:9876::1/126" ], "auto_route": true, "endpoint_independent_nat": false, "mtu": 9000, "platform": { "http_proxy": { "enabled": true, "server": "127.0.0.1", "server_port": 2080 } }, "stack": "system", "strict_route": false, "type": "tun" }, { "listen": "127.0.0.1", "listen_port": 2080, "type": "mixed", "users": [] } ], "outbounds": [ { "outbounds": [ "auto", "direct" ], "tag": "proxy", "type": "selector" }, { "interval": "10m", "outbounds": [], "tag": "auto", "tolerance": 50, "type": "urltest", "url": "http://www.gstatic.com/generate_204" }, { "tag": "direct", "type": "direct" } ], "route": { "auto_detect_interface": true, "final": "proxy", "rule_set": [ 
            { "download_detour": "direct", "format": "binary", "tag": "geosite-ads", "type": "remote", "url": "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-category-ads-all.srs" }, 
            { "download_detour": "direct", "format": "binary", "tag": "geosite-private", "type": "remote", "url": "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-private.srs" }, 
            { "download_detour": "direct", "format": "binary", "tag": "geosite-ir", "type": "remote", "url": "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-iran.srs" }, 
            { "download_detour": "direct", "format": "binary", "tag": "geoip-private", "type": "remote", "url": "https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-private.srs" }, 
            { "download_detour": "direct", "format": "binary", "tag": "geoip-ir", "type": "remote", "url": "https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-iran.srs" } 
        ], "rules": [ { "action": "sniff" }, { "action": "route", "clash_mode": "Direct", "outbound": "direct" }, { "action": "route", "clash_mode": "Global", "outbound": "proxy" }, { "action": "hijack-dns", "protocol": "dns" }, { "action": "route", "outbound": "direct", "rule_set": [ "geoip-private", "geosite-private", "geosite-ir", "geoip-ir" ] }, { "action": "reject", "rule_set": [ "geosite-ads" ] } ] } };
        const urltestOutbound = singboxTemplate.outbounds.find(o => o.tag === 'auto');
        const allEndpoints = [...allFetchedEndpoints.ipv4, ...allFetchedEndpoints.ipv6];
        allEndpoints.forEach(ep => {
            const { server, port } = parseEndpoint(ep);
            const outboundTag = `WARP-${server}:${port}`;
            const wireguardOutbound = { "type": "wireguard", "tag": outboundTag, "server": server, "server_port": port,"local_address": [`${account.v4}/32`, `${account.v6}/128`], "private_key": account.privateKey, "peer_public_key": account.peerPublicKey, "reserved": account.reserved, "mtu": 1280 };
            singboxTemplate.outbounds.push(wireguardOutbound);
            if (urltestOutbound) urltestOutbound.outbounds.push(outboundTag);
        });
        const now = new Date(); 
        const name = `WG ${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        const encodedName = encodeURIComponent(name);
        const { server, port } = parseEndpoint(endpoint);
        const addressesWithCidr = `${account.v4}/32,${account.v6}/128`;
        const addressesNoCidr = `${account.v4},${account.v6}`;
        const encodedReserved = encodeURIComponent(account.reserved.join(',')); 
        const encodedPeerPubKey = encodeURIComponent(account.peerPublicKey); 
        const encodedPrivateKey = encodeURIComponent(account.privateKey);
        const nekoboxReserved = btoa(String.fromCharCode(...account.reserved));
        const nekoboxConfig = { "type": "wireguard", "tag": "proxy", "server": server, "server_port": port, "private_key": account.privateKey, "peer_public_key": account.peerPublicKey, "local_address": [ `${account.v4}/32`, `${account.v6}/128` ], "mtu": 1280, "reserved": nekoboxReserved, "pre_shared_key": "", "domain_strategy": "" };
        
        return {
            standard: `[Interface]\nPrivateKey = ${account.privateKey}\nAddress = ${addressesWithCidr}\nDNS = ${dns}\nMTU = 1280\n\n[Peer]\nPublicKey = ${account.peerPublicKey}\nAllowedIPs = 0.0.0.0/0, ::/0\nEndpoint = ${endpoint}`,
            amnezia: `[Interface]\nPrivateKey = ${account.privateKey}\nAddress = ${addressesWithCidr}\nDNS = ${dns}\nMTU = 1280\nJc = 4\nJmin = 40\nJmax = 70\n\n[Peer]\nPublicKey = ${account.peerPublicKey}\nAllowedIPs = 0.0.0.0/0, ::/0\nEndpoint = ${endpoint}`,
            singbox: JSON.stringify(singboxTemplate, null, 2),
            v2rayngUrl: `wireguard://${encodedPrivateKey}@${endpoint}?address=${encodeURIComponent(addressesWithCidr)}&reserved=${encodedReserved}&publickey=${encodedPeerPubKey}&mtu=1280#${encodedName}`,
            streisandUrl: `wireguard://${endpoint}?private_key=${encodedPrivateKey}&peer_public_key=${encodedPeerPubKey}&mtu=1280&address=${encodeURIComponent(addressesWithCidr)}&reserved=${encodedReserved}`,
            shadowrocketStandardUrl: `wg://${endpoint}?publicKey=${encodedPeerPubKey}&privateKey=${encodedPrivateKey}&ip=${encodeURIComponent(addressesNoCidr)}&mtu=1280&dns=${encodeURIComponent(dns)}&udp=1&reserved=${encodedReserved}#${encodedName}`,
            shadowrocketAmneziaUrl: `wg://${endpoint}?publicKey=${encodedPeerPubKey}&privateKey=${encodedPrivateKey}&ip=${encodeURIComponent(addressesNoCidr)}&mtu=1280&dns=${encodeURIComponent(dns)}&udp=1&reserved=${encodedReserved}&obfs=amneziawg&obfsParam=4,40,70,0,0,0,0,0,0&flag=US#${encodedName}`,
            nekoboxJson: JSON.stringify(nekoboxConfig, null, 2)
        };
    }

    async function generateWireGuardKeypair() {
        const keyPair = await crypto.subtle.generateKey(
            { name: "X25519" },
            true,
            ["deriveBits"]
        );

        const privateJwk = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
        const publicJwk  = await crypto.subtle.exportKey("jwk", keyPair.publicKey);

        const toStdBase64 = (b64url) =>
            b64url
                .replace(/-/g, "+")
                .replace(/_/g, "/") + "=";

        return {
            privateKey: toStdBase64(privateJwk.d),
            publicKey:  toStdBase64(publicJwk.x),
        };
    }
    
    // ================================================================
    // RENDERING FUNCTIONS (MODIFIED FOR BETTER UX)
    // ================================================================
    function renderResults() {
        const resultsOutputDiv = document.getElementById('results-output');
        const resultsSidebarDiv = document.getElementById('results-sidebar');

        // Clear previous content
        resultsOutputDiv.innerHTML = '';
        resultsSidebarDiv.innerHTML = '';

        // Render output section
        resultsOutputDiv.innerHTML = `
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 md:p-8 shadow-2xl h-full">
            <h2 class="text-2xl font-bold mb-4 text-white text-center">${t('configurationsReady')}</h2>
            <div class="border-b border-gray-700 mb-4">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-400" data-tab-target="#tab-standard">${t('standardWG')}</button>
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-300 hover:border-gray-500 mx-4" data-tab-target="#tab-amnezia">${t('amneziaWG')}</button>
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-300 hover:border-gray-500" data-tab-target="#tab-singbox">${t('singBox')}</button>
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-300 hover:border-gray-500 mx-4" data-tab-target="#tab-app-urls">${t('appUrls')}</button>
                </nav>
            </div>
            <div id="tab-content-area"></div>
        </div>`;

        // Render sidebar section
        resultsSidebarDiv.innerHTML = `
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-2xl text-center">
            <h3 id="qrcode-title" class="font-semibold text-lg mb-4 text-indigo-400"></h3>
            <div id="qrcode-wrapper" class="p-4 bg-white rounded-lg shadow-md inline-block">
                <div id="qrcode"></div>
                <p id="qrcode-message" class="hidden text-center text-gray-700 p-8 font-medium">${t('qrCodeNotScannable')}</p>
            </div>
        </div>
        <div id="settings-panel" class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-2xl space-y-6 sticky top-4">
            ${createEndpointSelectorHTML('endpoint-selector-main')}
            ${createDnsSelectorHTML()}
        </div>`;

        // Populate tabs and update configurations
        populateTabs();
        updateDisplayedConfigs();

        // Synchronize selectors with current state
        syncSelectors();

        // Show results section with animation
        if (resultsDiv.classList.contains('hidden')) {
            resultsDiv.classList.remove('hidden');
            resultsDiv.style.opacity = 0;
            setTimeout(() => {
                resultsDiv.style.transition = 'opacity 0.5s ease-in-out';
                resultsDiv.style.opacity = 1;
            }, 10);
        }
    }

    function populateTabs() {
        const tabContentArea = document.getElementById('tab-content-area');
        const templates = [ 
            { id: "standard", title: t('standardWireGuardFormat'), color: "blue" }, 
            { id: "amnezia", title: t('amneziaWGFormat'), color: "purple" }, 
            { id: "singbox", title: t('singBoxFormat'), color: "teal" }, 
            { id: "app-urls", title: t('clientSpecificUrls'), color: "green" } 
        ];
        let html = '';
        templates.forEach(data => {
            if (data.id === 'app-urls') {
                html += `
                    <div id="tab-app-urls" class="tab-pane hidden space-y-4">
                        <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-700 text-center">
                            <h4 class="font-semibold text-lg text-indigo-400 mb-2">Dynamic Subscriptions</h4>
                            <p class="text-sm text-gray-400 mb-4">Generate a single, stable link for your favorite client. The link will always provide fresh configs with the best available endpoints.</p>
                            <button id="generateAppSubLinksBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                                Generate Subscription Links
                            </button>
                        </div>
                        <p class="text-sm text-center text-gray-400 pt-2">${t('clickForQrCode')}</p>
                        ${createAppContentSectionHTML('nekobox', t('nekoBoxAndroid'))}
                        ${createAppContentSectionHTML('v2rayng', t('v2RayNGAndroid'))}
                        ${createAppContentSectionHTML('streisand', t('streisandiOS'))}
                        ${createAppContentSectionHTML('shadowrocket-std', t('shadowrocketStandard'))}
                        ${createAppContentSectionHTML('shadowrocket-amz', t('shadowrocketAmnezia'))}
                    </div>`;
            } else {
                const titleTooltip = data.id === 'amnezia' ? `<span class="inline-block" data-tippy-content="Uses jitter parameters to obfuscate traffic, may help bypass some restrictions."><svg class="w-4 h-4 inline-block ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg></span>` : '';
                html += `
                    <div id="tab-${data.id}" class="tab-pane ${data.id !== 'standard' ? 'hidden' : ''}">
                        <h3 class="font-semibold text-lg mb-2 text-indigo-400">${data.title} ${titleTooltip}</h3>
                        ${createActionButtons('', data.color, data.id)}
                        <pre class="bg-gray-900 p-4 rounded-lg overflow-x-auto text-sm break-all max-h-[300px]"><code></code></pre>
                        ${createDownloadLinks(data.id)}
                    </div>`;
            }
        });
        tabContentArea.innerHTML = html;
        const firstUrlSection = tabContentArea.querySelector('.content-section');
        if(firstUrlSection) firstUrlSection.classList.add('active');
    }
    
    // ================================================================
    // ASYNC PROCESSES & STATE MANAGEMENT
    // ================================================================
    async function startNewGeneration(button) { 
        const originalText = button.innerHTML; 
        button.disabled = true; 
        button.innerHTML = loadingButtonHTML.replace(t('sharing'), t('registeringAccount')); 
        try { 
            const newAccount = await fetchAccountFromWorker(); 
            const name = await showModal({
                title: t('enterName'),
                description: "This name will help you identify the configuration later.",
                placeholder: t('configNamePlaceholder'),
                confirmText: "Save Config"
            });
            if (name === null) return;
            const finalName = name || t('configNamePlaceholder');
            const accounts = getSavedAccounts(); 
            accounts.push({ name: finalName, account: newAccount }); 
            saveAccounts(accounts); 
            setStatus(t('newConfigSaved')); 
            await initialize(); 
            savedConfigsDropdown.value = accounts.length - 1;
            await loadSelectedConfig(false); 
        } catch (error) { 
            console.error("New generation process failed:", error); 
            setStatus(t('errorOccurred')); 
        } finally { 
            button.disabled = false; 
            button.innerHTML = originalText; 
            setTimeout(() => setStatus(""), 3000); 
        } 
    }
    
    async function loadSelectedConfig(showStatus = true) {
        const selectedIndex = savedConfigsDropdown.value;
        const accounts = getSavedAccounts();
        if (selectedIndex < 0 || selectedIndex >= accounts.length) {
            resultsDiv.classList.add('hidden');
            return;
        }
        if (showStatus) setStatus(t('loadingConfig'));
        currentAccount = accounts[selectedIndex].account;
        allFetchedEndpoints = await fetchAllEndpoints();

        // Ensure we have a valid endpoint
        if (allFetchedEndpoints.ipv4.length > 0) {
            currentEndpoint = allFetchedEndpoints.ipv4[0];
        } else if (allFetchedEndpoints.ipv6.length > 0) {
            currentEndpoint = allFetchedEndpoints.ipv6[0];
        } else {
            currentEndpoint = ''; // Fallback
        }

        renderResults();
        if (showStatus) setTimeout(() => setStatus(""), 3000);
    }
    
    function showManagerUI(accounts) { 
        firstTimeGeneratorDiv.classList.add('hidden'); 
        configManagerDiv.classList.remove('hidden'); 
        savedConfigsDropdown.innerHTML = ''; 
        accounts.forEach((acc, index) => { 
            const option = document.createElement('option'); 
            option.value = index; 
            option.textContent = acc.name; 
            savedConfigsDropdown.appendChild(option); 
        }); 
    }
    
    async function initialize() { 
        const accounts = getSavedAccounts(); 
        if (accounts.length > 0) { 
            showManagerUI(accounts); 
            await loadSelectedConfig(false); 
        } else { 
            firstTimeGeneratorDiv.classList.remove('hidden'); 
            configManagerDiv.classList.add('hidden'); 
            resultsDiv.classList.add('hidden'); 
        } 
    }
    
    // ================================================================
    // HTML ELEMENT CREATION
    // ================================================================
    function escapeHtml(text) { return text ? text.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">") : ''; }
    
    function createAppContentSectionHTML(id, title) { 
        const isJson = id === 'nekobox'; 
        const inputElement = isJson ? `<textarea id="${id}-content-input" readonly rows="8" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-xs text-gray-300 font-mono resize-none"></textarea>` : `<input id="${id}-content-input" type="text" readonly class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm text-gray-300 font-mono">`; 
        return `<div id="${id}-section" class="content-section p-4 rounded-lg cursor-pointer" data-title="${escapeHtml(title)}"><h4 class="font-semibold text-lg text-indigo-400 mb-2">${title}</h4><div class="flex items-center gap-2">${inputElement}<button class="copy-btn self-start whitespace-nowrap bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">${t('copy')}</button></div></div>`; 
    }
    
    function createDnsSelectorHTML() { 
        const defaultDnsOptions = { '1.1.1.1': t('cloudflare'), '8.8.8.8, 8.8.4.4': t('google'), '9.9.9.9': t('quad9'), '208.67.222.222, 208.67.220.220': t('opendns') };
        const customDnsList = getCustomDnsList();
        let selectHtml = `<div class="space-y-4"><h4 class="text-lg font-semibold text-gray-200 text-center">${t('selectDns')}</h4><div class="dns-container flex flex-col sm:flex-row gap-2 items-center"><select class="dns-select block w-full flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500"><optgroup label="Defaults">`;
        for (const [value, text] of Object.entries(defaultDnsOptions)) { selectHtml += `<option value="${value}">${text}</option>`; }
        selectHtml += `</optgroup>`;
        if (customDnsList.length > 0) {
            selectHtml += `<optgroup label="Custom">`;
            customDnsList.forEach(item => { selectHtml += `<option value="${item.value}" data-custom-dns="true">${item.name} (${item.value})</option>`; });
            selectHtml += `</optgroup>`;
        }
        selectHtml += `<option value="custom">${t('custom')}</option></select>`;
        const customInputHtml = `<input type="text" placeholder="e.g., 1.0.0.1" class="dns-custom-input hidden w-full sm:w-1/3 bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">`; 
        const saveButtonHtml = `<button class="save-custom-dns-btn hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">${t('save')}</button>`; 
        const deleteButtonHtml = `<button class="delete-custom-dns-btn hidden bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">${t('delete')}</button>`; 
        return `${selectHtml}${customInputHtml}${saveButtonHtml}${deleteButtonHtml}</div></div>`;
    }
    
    function createDownloadLinks(clientType) { 
        const links = { standard: [{ name: t('windows'), url: 'https://download.wireguard.com/windows-client/wireguard-installer.exe' }, { name: t('android'), url: 'https://play.google.com/store/apps/details?id=com.wireguard.android' }, { name: t('ios'), url: 'https://apps.apple.com/us/app/wireguard/id1441195209' }, { name: t('linux'), url: 'https://www.wireguard.com/install/' }], amnezia: [{ name: t('windows'), url: 'https://github.com/amnezia-vpn/amneziawg-windows-client/releases/latest' }, { name: t('android'), url: 'https://play.google.com/store/apps/details?id=org.amnezia.awg&hl=fa' }, { name: t('ios'), url: 'https://apps.apple.com/de/app/amneziawg/id6478942365' }, { name: t('linux'), url: 'https://github.com/amnezia-vpn/amneziawg-linux-kernel-module' }], singbox: [{ name: t('windows'), url: 'https://github.com/hiddify/hiddify-app/releases/latest' }, { name: t('android'), url: 'https://github.com/SagerNet/sing-box-for-android/releases/latest' }, { name: t('ios'), url: 'https://apps.apple.com/us/app/sing-box-vt/id6673731168' }, { name: t('linux'), url: 'https://github.com/SagerNet/sing-box/releases/latest' }] };
        const clientLinks = links[clientType]; 
        if (!clientLinks) return ''; 
        let linksHtml = `<div class="mt-6 pt-4 border-t border-gray-700"><h4 class="text-sm font-semibold text-gray-400 mb-3 text-center">${t('downloadClient')}</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">`; 
        clientLinks.forEach(link => { linksHtml += `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="block bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg text-sm transition-colors">${link.name}</a>`; }); 
        return linksHtml + '</div></div>'; 
    }
    
    function createEndpointSelectorHTML(groupName) { 
        let html = `<div class="space-y-4"><h4 class="text-lg font-semibold text-gray-200 text-center">${t('selectEndpoint')}</h4>`;
        html += `<div class="endpoint-tabs flex mb-2"><button class="endpoint-tab active" data-type="ipv4">${t('ipv4')}</button><button class="endpoint-tab" data-type="ipv6">${t('ipv6')}</button></div>`;
        html += `<div class="endpoint-tab-content ipv4" data-type="ipv4"><p class="text-sm text-center text-gray-400 mb-4"><span class="font-bold text-indigo-400">${t('recommended')}:</span> ${t('recommendedText')}</p><div class="max-h-[200px] overflow-y-auto bg-gray-900 p-3 rounded-lg border border-gray-700 space-y-2">`;
        if (allFetchedEndpoints.ipv4.length > 0) {
            allFetchedEndpoints.ipv4.forEach(ep => { html += `<label class="flex items-center p-2 rounded-md hover:bg-gray-700/50 transition-colors cursor-pointer"><input type="radio" name="${groupName}" value="${ep}" class="h-4 w-4 text-indigo-600 bg-gray-700 border-gray-600 focus:ring-indigo-500 focus:ring-offset-gray-800"><span class="ml-3 text-gray-300 font-mono text-sm flex-grow">${ep}</span><span class="endpoint-latency latency-indicator latency-unknown" title="${t('latencyUnknown')}"></span></label>`; });
        } else { html += `<p class="text-center text-gray-400 py-4">${t('noIPv4Endpoints')}</p>`; }
        html += `</div></div>`;
        html += `<div class="endpoint-tab-content ipv6 hidden" data-type="ipv6"><p class="text-sm text-center text-gray-400 mb-4">${t('ipv6Text')}</p><div class="max-h-[200px] overflow-y-auto bg-gray-900 p-3 rounded-lg border border-gray-700 space-y-2">`;
        if (allFetchedEndpoints.ipv6.length > 0) {
            allFetchedEndpoints.ipv6.forEach(ep => { html += `<label class="flex items-center p-2 rounded-md hover:bg-gray-700/50 transition-colors cursor-pointer"><input type="radio" name="${groupName}" value="${ep}" class="h-4 w-4 text-indigo-600 bg-gray-700 border-gray-600 focus:ring-indigo-500 focus:ring-offset-gray-800"><span class="ml-3 text-gray-300 font-mono text-sm flex-grow">${ep}</span><span class="endpoint-latency latency-indicator latency-unknown" title="${t('latencyUnknown')}"></span></label>`; });
        } else { html += `<p class="text-center text-gray-400 py-4">${t('noIPv6Endpoints')}</p>`; }
        html += `</div></div>`;
        html += `<div class="text-center space-y-3 pt-4 border-t border-gray-600/50">
            <button class="test-latency-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">${t('testLatency')}</button>
            <div class="flex justify-center items-center gap-4 text-xs text-gray-400">
                <span class="flex items-center gap-1.5"><span class="latency-indicator latency-fast"></span> ${t('latencyFast')}</span>
                <span class="flex items-center gap-1.5"><span class="latency-indicator latency-medium"></span> ${t('latencyMedium')}</span>
                <span class="flex items-center gap-1.5"><span class="latency-indicator latency-slow"></span> ${t('latencySlow')}</span>
            </div>
        </div>`;
        return html + '</div>';
    }
    
    function createActionButtons(content, color, id) { 
        const hasDownload = id === 'standard' || id === 'amnezia'; 
        const filename = id === 'standard' ? 'wg-config.conf' : 'amnezia-config.conf'; 
        let buttonsHtml = `<div class="flex space-x-2 mb-2"><button class="copy-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">${t('copy')}</button>`; 
        if (hasDownload) { buttonsHtml += `<button class="download-btn flex-1 bg-${color}-600 hover:bg-${color}-700 text-white font-semibold py-2 px-4 rounded-lg" data-filename="${filename}">${t('downloadConf')}</button>`; } 
        buttonsHtml += `<button class="share-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">${t('shareLink')}</button></div><div class="share-result-container hidden mt-2"><input type="text" readonly class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm text-gray-300"><button class="copy-link-btn w-full mt-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-lg text-sm">${t('linkCopied')}</button></div>`; 
        return buttonsHtml; 
    }
    
    function updateQrCode(content, title) { 
        const qrcodeContainer = document.getElementById('qrcode'), qrcodeTitle = document.getElementById('qrcode-title'), qrcodeMessage = document.getElementById('qrcode-message'); 
        qrcodeTitle.textContent = title; 
        if (content) { 
            qrcodeContainer.innerHTML = ''; 
            new QRCode(qrcodeContainer, { text: content, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.L }); 
            qrcodeContainer.classList.remove('hidden'); 
            qrcodeMessage.classList.add('hidden'); 
        } else { 
            qrcodeContainer.innerHTML = ''; 
            qrcodeContainer.classList.add('hidden'); 
            qrcodeMessage.classList.remove('hidden'); 
        } 
    }
    
    function syncSelectors() {
        // Synchronize endpoint selectors
        document.querySelectorAll('input[name="endpoint-selector-main"]').forEach(radio => {
            radio.checked = radio.value === currentEndpoint;
        });

        // Synchronize DNS selector
        const dnsSelect = document.querySelector('#settings-panel .dns-select');
        if (dnsSelect) {
            dnsSelect.value = currentDns;
            const isCustom = !Array.from(dnsSelect.options).some(opt => opt.value === currentDns);
            if (isCustom) dnsSelect.value = 'custom';

            const isCustomSelected = dnsSelect.value === 'custom';
            const container = dnsSelect.closest('.dns-container');
            container.querySelector('.dns-custom-input').classList.toggle('hidden', !isCustomSelected);
            if (isCustomSelected) container.querySelector('.dns-custom-input').value = currentDns;

            const selectedOption = Array.from(dnsSelect.options).find(opt => opt.value === dnsSelect.value);
            const isDataCustom = selectedOption && selectedOption.dataset.customDns === 'true';
            container.querySelector('.save-custom-dns-btn').classList.toggle('hidden', !isCustomSelected);
            container.querySelector('.delete-custom-dns-btn').classList.toggle('hidden', !isDataCustom);
        }
    }
    
    function updateDisplayedConfigs() {
        if (!currentAccount) return;
        generatedConfigs = generateAllFormats(currentAccount, currentEndpoint, currentDns);
        ['standard', 'amnezia', 'singbox'].forEach(id => {
            const tabPane = document.getElementById(`tab-${id}`); if (!tabPane) return;
            const newContent = generatedConfigs[id];
            tabPane.querySelector('code').textContent = newContent;
            tabPane.querySelector('.copy-btn')?.setAttribute('data-clipboard-text', escape(newContent));
            tabPane.querySelector('.download-btn')?.setAttribute('data-download-content', escape(newContent));
            tabPane.querySelector('.share-btn')?.setAttribute('data-share-content', escape(newContent));
            tabPane.querySelector('.share-result-container').classList.add('hidden');
        });
        Object.entries(idToConfigKeyMap).forEach(([sectionId, configKey]) => {
            const input = document.getElementById(`${sectionId.replace('-section', '')}-content-input`); if (input) {
                const newContent = generatedConfigs[configKey]; input.value = newContent;
                const section = document.getElementById(sectionId);
                section.querySelector('.copy-btn')?.setAttribute('data-clipboard-text', escape(newContent));
            }
        });
        const activePane = document.querySelector('.tab-pane:not(.hidden)');
        if (activePane) updateQrCodeForActiveTab(activePane.id);
    }
    
    function updateQrCodeForActiveTab(activeTabId) {
        if (!generatedConfigs) return;
        switch (activeTabId) {
            case 'tab-standard': updateQrCode(generatedConfigs.standard, t('qrCodeStandard')); break;
            case 'tab-amnezia': updateQrCode(generatedConfigs.amnezia, t('qrCodeAmnezia')); break;
            case 'tab-app-urls': { 
                const activeContentSection = document.querySelector('.content-section.active'); 
                if(activeContentSection) { 
                    const configKey = idToConfigKeyMap[activeContentSection.id]; 
                    updateQrCode(generatedConfigs[configKey], activeContentSection.dataset.title); 
                } 
                break; 
            }
            case 'tab-singbox': { 
                const singboxShareInput = document.querySelector('#tab-singbox .share-result-container input'); 
                if (singboxShareInput && singboxShareInput.value) { 
                    updateQrCode(singboxShareInput.value, t('qrCodeSingBox')); 
                } else { updateQrCode(null, t('qrCodeNotScannable')); } 
                break; 
            }
            default: updateQrCode(null, t('qrCodeNotScannable')); break;
        }
    }
    
    // ================================================================
    // EVENT LISTENERS
    // ================================================================
    generateBtn.addEventListener('click', e => startNewGeneration(e.currentTarget));
    generateNewBtn.addEventListener('click', e => startNewGeneration(e.currentTarget));
    savedConfigsDropdown.addEventListener('change', () => loadSelectedConfig());
    updateEndpointsBtn.addEventListener('click', () => loadSelectedConfig());

    deleteConfigBtn.addEventListener('click', () => { 
        const selectedIndex = savedConfigsDropdown.selectedIndex; 
        const accounts = getSavedAccounts(); 
        if (selectedIndex < 0) return; 
        if (confirm(t('deleteConfirm', { name: accounts[selectedIndex].name }))) { 
            accounts.splice(selectedIndex, 1); 
            saveAccounts(accounts); 
            setStatus(t('configurationDeleted')); 
            initialize(); 
        } 
    });

    renameConfigBtn.addEventListener('click', async () => { 
        const selectedIndex = savedConfigsDropdown.selectedIndex; 
        const accounts = getSavedAccounts(); 
        if (selectedIndex < 0) return; 
        const oldName = accounts[selectedIndex].name; 
        const newName = await showModal({
            title: t('enterNewName'),
            description: `Current name: "${oldName}"`,
            initialValue: oldName,
            confirmText: "Rename"
        });
        if (newName && newName !== oldName) { 
            accounts[selectedIndex].name = newName; 
            saveAccounts(accounts); 
            setStatus(t('configurationRenamed')); 
            savedConfigsDropdown.options[selectedIndex].textContent = newName; 
        } 
    });
    
    resultsDiv.addEventListener('click', async e => {
        const target = e.target;
        const button = target.closest('button');

        // Handle Tab Clicks
        if (target.classList.contains('tab-btn')) {
            const activeTabClasses = ['border-indigo-500', 'text-indigo-400'];
            const inactiveTabClasses = ['border-transparent', 'text-gray-400', 'hover:text-gray-300', 'hover:border-gray-500'];

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove(...activeTabClasses);
                btn.classList.add(...inactiveTabClasses);
            });
            target.classList.add(...activeTabClasses);
            target.classList.remove(...inactiveTabClasses);
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            const activePane = document.querySelector(target.dataset.tabTarget);
            activePane.classList.remove('hidden');
            updateQrCodeForActiveTab(activePane.id);

            const activeTabId = target.dataset.tabTarget;
            const resultsSidebar = document.getElementById('results-sidebar');
            const settingsPanel = document.getElementById('settings-panel');
            if (activeTabId === '#tab-singbox' || activeTabId === '#tab-app-urls') {
                resultsSidebar.classList.remove('space-y-6');
                settingsPanel.classList.add('hidden');
            } else {
                resultsSidebar.classList.add('space-y-6');
                settingsPanel.classList.remove('hidden');
            }
            return; // Done
        }

        // Handle Endpoint Type Tabs (IPv4/IPv6)
        if (target.classList.contains('endpoint-tab')) {
            const tabContainer = target.closest('.endpoint-tabs');
            const tabContents = tabContainer.parentElement.querySelectorAll('.endpoint-tab-content');
            tabContainer.querySelectorAll('.endpoint-tab').forEach(tab => tab.classList.remove('active'));
            target.classList.add('active');
            const tabType = target.dataset.type;
            tabContents.forEach(content => content.classList.toggle('hidden', content.dataset.type !== tabType));
            return; // Done
        }

        // Handle App URL Section Clicks for QR Code
        const contentSection = target.closest('.content-section');
        if (contentSection) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            contentSection.classList.add('active');
            updateQrCodeForActiveTab('tab-app-urls');
            return; // Done
        }

        // Handle all other buttons inside the results area
        if (button) {
            if (button.id === 'generateAppSubLinksBtn') {
                const WORKER_BASE_URL = "https://warp-sub.YOUR-WORKER.workers.dev"; // Use your worker URL
                const accounts = getSavedAccounts();
                if (accounts.length === 0) {
                    alert(t('noSavedConfigsError'));
                    return;
                }

                const essentialData = accounts.map(acc => ({
                    privateKey: acc.account.privateKey, v4: acc.account.v4, v6: acc.account.v6,
                    peerPublicKey: acc.account.peerPublicKey, reserved: acc.account.reserved
                }));

                const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(essentialData));
                const clients = [
                    { id: 'v2rayng', name: t('nekoBoxV2rayNG', { default: 'V2RayNG / NekoBox' }) },
                    { id: 'streisand', name: t('streisandiOS') },
                    { id: 'shadowrocket-std', name: t('shadowrocketStandard') },
                    { id: 'shadowrocket-amz', name: t('shadowrocketAmnezia') }
                ];

                const modal = document.getElementById('customModal');
                const linksContainer = document.createElement('div');
                linksContainer.id = 'subscriptionLinksContainer';
                linksContainer.className = 'space-y-4';
                linksContainer.innerHTML = clients.map(client => `
                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-300">${client.name}</label>
                    <div class="flex gap-2">
                        <input type="text" value="${WORKER_BASE_URL}/sub/${client.id}/${compressedData}" readonly class="w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-2.5 text-xs font-mono focus:ring-indigo-500 focus:border-indigo-500">
                        <button class="copy-modal-link-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">${t('copy')}</button>
                    </div>
                </div>
            `).join('');

                modal.querySelector('#modalInput').classList.add('hidden');
                modal.querySelector('#modalInput').parentElement.appendChild(linksContainer);
                modal.querySelector('#modalTitle').textContent = t('appSubscriptionLinksTitle');
                modal.querySelector('#modalDescription').textContent = t('appSubscriptionLinksDesc');
                modal.querySelector('#modalConfirm').classList.add('hidden');
                modal.querySelector('#modalCancel').textContent = t('close');
                modal.classList.remove('hidden');

                linksContainer.querySelectorAll('.copy-modal-link-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const input = btn.previousElementSibling;
                        btn.disabled = true;
                        navigator.clipboard.writeText(input.value).then(() => {
                            const originalText = btn.textContent;
                            btn.textContent = t('copied');
                            setTimeout(() => {
                                if (document.body.contains(btn)) {
                                    btn.textContent = originalText;
                                    btn.disabled = false;
                                }
                            }, 2000);
                        }).catch(err => { console.error('Failed to copy:', err); btn.disabled = false; });
                    });
                });

                const restoreModal = () => {
                    const tempContainer = document.getElementById('subscriptionLinksContainer');
                    if (tempContainer) tempContainer.remove();
                    modal.querySelector('#modalInput').classList.remove('hidden');
                    modal.querySelector('#modalConfirm').classList.remove('hidden');
                    modal.querySelector('#modalCancel').textContent = t('cancel');

                    // THIS IS THE FIX: Add this line to hide the modal.
                    modal.classList.add('hidden');

                    modal.removeEventListener('click', cleanupHandler);
                    document.removeEventListener('keydown', escapeHandler);
                };
                const cleanupHandler = (evt) => { if (evt.target === modal || evt.target === modal.querySelector('#modalCancel')) restoreModal(); };
                const escapeHandler = (evt) => { if (evt.key === "Escape") restoreModal(); };
                modal.addEventListener('click', cleanupHandler);
                document.addEventListener('keydown', escapeHandler);
                return;
            }

            if (button.classList.contains('copy-btn')) {
                const textToCopy = unescape(button.dataset.clipboardText);
                const originalText = button.innerHTML;
                button.disabled = true;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    button.innerHTML = t('copied');
                    setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
                });
                return;
            }

            if (button.classList.contains('download-btn')) {
                const content = unescape(button.dataset.downloadContent);
                const blob = new Blob([content], { type: 'application/octet-stream' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = button.dataset.filename;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(a.href);
                document.body.removeChild(a);
                return;
            }

            if (button.classList.contains('share-btn')) {
                const contentToShare = unescape(button.dataset.shareContent);
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = loadingButtonHTML;
                try {
                    const result = await shzAl.uploadPaste(contentToShare, { expiration: '1h' });
                    const container = button.closest('div').nextElementSibling;
                    container.querySelector('input').value = result.url;
                    container.classList.remove('hidden');
                    if (button.closest('.tab-pane')?.id === 'tab-singbox') updateQrCode(result.url, t('qrCodeSingBox'));
                } catch (error) {
                    console.error("Share failed:", error);
                    alert(t('shareFailed'));
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
                return;
            }

            if (button.classList.contains('copy-link-btn')) {
                const linkToCopy = button.previousElementSibling.value;
                const originalText = button.innerHTML;
                button.disabled = true;
                navigator.clipboard.writeText(linkToCopy).then(() => {
                    button.innerHTML = t('linkCopied');
                    setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
                });
                return;
            }

            if (button.classList.contains('save-custom-dns-btn')) {
                const container = button.closest('.dns-container');
                const customInput = container.querySelector('.dns-custom-input');
                const dnsValue = customInput.value.trim();
                if (!dnsValue) { alert(t('enterCustomDns')); return; }
                const dnsName = await showModal({ title: t('enterDnsName', { value: dnsValue }), placeholder: t('myCustomDns'), confirmText: t('save') });
                if (dnsName) {
                    const dnsList = getCustomDnsList();
                    if (dnsList.some(item => item.value === dnsValue)) { alert(t('dnsAlreadySaved')); return; }
                    dnsList.push({ name: dnsName || t('myCustomDns'), value: dnsValue });
                    saveCustomDnsList(dnsList);
                    currentDns = dnsValue;
                    renderResults();
                }
                return;
            }

            if (button.classList.contains('delete-custom-dns-btn')) {
                const dnsValueToDelete = button.closest('.dns-container').querySelector('.dns-select').value;
                if (confirm(t('deleteDnsConfirm', { value: dnsValueToDelete }))) {
                    let dnsList = getCustomDnsList();
                    dnsList = dnsList.filter(item => item.value !== dnsValueToDelete);
                    saveCustomDnsList(dnsList);
                    currentDns = '1.1.1.1';
                    renderResults();
                }
                return;
            }

            if (button.classList.contains('test-latency-btn')) {
                testAllEndpointsLatency();
                return;
            }
        }
    });
    
    resultsDiv.addEventListener('change', e => {
        const target = e.target;
        if (target.matches('input[name^="endpoint-selector-"]')) {
            currentEndpoint = target.value;
            updateDisplayedConfigs();
        } else if (target.matches('.dns-custom-input')) {
            currentDns = target.value.trim();
            updateDisplayedConfigs();
        } else if (target.matches('.dns-select')) {
            const newDnsValue = target.value;
            if (newDnsValue === 'custom') {
                const container = target.closest('.dns-container');
                container.querySelector('.dns-custom-input').classList.remove('hidden');
                container.querySelector('.save-custom-dns-btn').classList.remove('hidden');
                container.querySelector('.delete-custom-dns-btn').classList.add('hidden');
            } else {
                currentDns = newDnsValue;
                updateDisplayedConfigs();
                syncSelectors();
            }
        }
    });
    
    // How to Use Listeners Removed
    
    // ================================================================
    // MISC & UTILITY FUNCTIONS
    // ================================================================
    function parseEndpoint(endpoint) { if (endpoint.startsWith('[')) { const c=endpoint.indexOf(']'); return { server: endpoint.substring(1, c), port: parseInt(endpoint.substring(c + 2)), type: 'ipv6' }; } else { const [s, p] = endpoint.split(':'); return { server: s, port: parseInt(p), type: 'ipv4' }; } }
    async function testEndpointLatency(endpoint) {
        const { server, port } = parseEndpoint(endpoint); const url = `https://${server}:${port}/cdn-cgi/trace`;
        try {
            const s=performance.now(); const c=new AbortController(); const t=setTimeout(()=>c.abort(),3000);
            await fetch(url, { signal: c.signal, mode: 'no-cors' });
            clearTimeout(t); const l=Math.round(performance.now()-s);
            let cL, lT; if (l<200){cL='latency-fast';lT=t('latencyFast')}else if(l<500){cL='latency-medium';lT=t('latencyMedium')}else{cL='latency-slow';lT=t('latencySlow')}
            return { latency: l, latencyClass: cL, latencyText: lT };
        } catch (error) { return { latency: null, latencyClass: 'latency-unknown', latencyText: t('latencyUnknown') }; }
    }
    async function testAllEndpointsLatency() {
        setStatus(t('testingLatency'));
        const allEndpoints = [...allFetchedEndpoints.ipv4, ...allFetchedEndpoints.ipv6];
        document.querySelectorAll('.endpoint-latency').forEach(el => { el.className = 'latency-indicator testing-indicator'; el.title = t('testingLatency'); });
        const results = await Promise.all(allEndpoints.map(async ep => ({ endpoint: ep, result: await testEndpointLatency(ep) })));
        results.forEach(({ endpoint, result }) => {
            const latencyIndicator = document.querySelector(`input[value="${endpoint}"]`)?.parentElement.querySelector('.endpoint-latency');
            if (latencyIndicator) {
                latencyIndicator.className = `endpoint-latency latency-indicator ${result.latencyClass}`;
                latencyIndicator.title = `${result.latencyText} (${result.latency || 'N/A'}ms)`;
            }
        });
        const validEndpoints = results.filter(r => r.result.latency !== null).sort((a, b) => a.result.latency - b.result.latency);
        if (validEndpoints.length > 0) {
            const fastest = validEndpoints[0];
            currentEndpoint = fastest.endpoint;
            document.querySelectorAll('input[name^="endpoint-selector-"]').forEach(r => r.checked = r.value === fastest.endpoint);
            updateDisplayedConfigs();
            setStatus(`${t('autoSelectFastest')}: ${fastest.endpoint} (${fastest.result.latency}ms)`);
        } else { setStatus(t('errorOccurred')); }
        setTimeout(() => setStatus(""), 3000);
    }
    
    initialize();
});
</script>
<script>
    navigator.sendBeacon("https://telemetry-update.endpointcache.workers.dev/log");
</script>
</body>
</html>